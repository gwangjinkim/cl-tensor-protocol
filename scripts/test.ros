#!/usr/bin/env ros
;; -*- mode: lisp; -*-
;; scripts/test.ros â€” deterministic test runner (run from repo root)

(require :asdf)

(let* ((root (uiop:getcwd))
       (asd  (merge-pathnames "cl-tensor-protocol.asd" root)))
  (asdf:load-asd asd))

(flet ((load-file-rel (rel)
         (load (merge-pathnames rel (uiop:getcwd)))))
  (handler-case
      (progn
        ;; Load protocol sources directly, in defined order
        (load-file-rel #P"src/package.lisp")
        (load-file-rel #P"src/conditions.lisp")
        (load-file-rel #P"src/dtype.lisp")
        (load-file-rel #P"src/backend.lisp")
        (load-file-rel #P"src/tensor.lisp")
        (load-file-rel #P"src/util.lisp")
        (load-file-rel #P"src/capability.lisp")
        (load-file-rel #P"src/registry.lisp")
        (load-file-rel #P"src/protocol.lisp")
        ;; Load CPU backend sources directly
        (load-file-rel #P"backends/cpu/package.lisp")
        (load-file-rel #P"backends/cpu/cpu-backend.lisp")
        (load-file-rel #P"backends/cpu/cpu-tensor.lisp")
        (load-file-rel #P"backends/cpu/cpu-ops.lisp")
        ;; Ensure FiveAM is available without compiling
        (asdf:operate 'asdf:load-source-op :fiveam)
        ;; Load core tests directly
        (load-file-rel #P"test/package.lisp")
        (load-file-rel #P"test/suite.lisp")
        (load-file-rel #P"test/protocol-tests.lisp")
        (load-file-rel #P"test/capability-tests.lisp")
        (load-file-rel #P"test/cpu-backend.lisp")
        ;; Load additional tests
        (load-file-rel #P"test/docs.lisp")
        (load-file-rel #P"test/conformance.lisp")
        (load-file-rel #P"backends/mlx/test/package.lisp")
        (load-file-rel #P"backends/mlx/test/smoke.lisp")
        (load-file-rel #P"backends/cuda/test/package.lisp")
        (load-file-rel #P"backends/cuda/test/smoke.lisp")

        ;; Optionally load MLX backend sources if MLX is present
        (when (find-package :mlx-cl)
          (ignore-errors
            (load-file-rel #P"backends/mlx/src/package.lisp")
            (load-file-rel #P"backends/mlx/src/backend.lisp")
            (load-file-rel #P"backends/mlx/src/tensor.lisp")
            (load-file-rel #P"backends/mlx/src/ops.lisp")))

        ;; Run all suites with robust failure detection
        (labels ((ci-search (needle hay)
                   (search (string-upcase needle) (string-upcase hay)))
                 (run-suite (name)
                   (let* ((res nil)
                          (out (with-output-to-string (s)
                                 (let ((*standard-output* s))
                                   (setf res (uiop:symbol-call :fiveam :run! name)))))
                          (status-sym (find-symbol "RESULTS-STATUS" :fiveam))
                          (failed (or (and status-sym (fboundp status-sym)
                                            (let ((st (funcall status-sym res)))
                                              (not (member st '(:success :pass :passed :ok)))))
                                       (ci-search "[FAIL]" out)
                                       (ci-search "failed" out))))
                     (when failed
                       (format *error-output* "~&TESTS FAILED in ~a~%~a~%" name out)
                       (uiop:quit 1)))) )
          (run-suite :cl-tensor-protocol/test)
          (run-suite :cl-tensor-backend-mlx/test)
          (run-suite :cl-tensor-backend-cuda/test))

        (format t "~&OK~%")
        (uiop:quit 0))
    (error (e)
      (format *error-output* "~&TESTS FAILED: ~a~%" e)
      (uiop:quit 1))))
